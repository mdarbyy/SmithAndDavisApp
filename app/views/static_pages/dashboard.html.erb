<% if @start_date.blank? || @end_date.blank? %>
  <div class="d-flex justify-content-center align-items-center" style="height: calc(100vh - 180px);">
    <div class="card p-4" style="max-width: 400px; width: 100%;">
      <h4 class="mb-3 text-center">Select a Date Range</h4>
      <%= form_with url: dashboard_path, method: :get, local: true do |form| %>
        <div class="mb-3">
          <%= form.label :start_date, "Start Date", class: "form-label" %>
          <div class="input-group">
            <%= form.text_field :start_date, class: "form-control datepicker", required: true, value: (params[:start_date].presence || Date.current.strftime("%m/%d/%Y")) %>
            <span class="input-group-text datepicker-icon">
              <i class="bi bi-calendar-date"></i>
            </span>
          </div>
        </div>
        <div class="mb-3">
          <%= form.label :end_date, "End Date", class: "form-label" %>
          <div class="input-group">
            <%= form.text_field :end_date, class: "form-control datepicker", required: true, value: (params[:end_date].presence || Date.current.strftime("%m/%d/%Y")) %>
            <span class="input-group-text datepicker-icon">
              <i class="bi bi-calendar-date"></i>
            </span>
          </div>
        </div>
        <div class="d-flex justify-content-end">
          <%= form.submit "View Dashboard", class: "btn btn-main", data: { turbo: false }, onclick:"show_spinner()" %>
        </div>
      <% end %>
    </div>
  </div>
<% else %>
    
	<div class="modal fade" id="totalSalesModal" tabindex="-1" aria-labelledby="totalSalesModalLabel" aria-hidden="true">
		<div class="modal-dialog custom-modal">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="totalSalesModalLabel"><b><span id="salesPersonName"></span></b> (<span id="salesPersonRecordCount"></span>)</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="scrollable-table show-scrollbar">
						<table class="table content" id="totalSalesModalTable">
							<thead>
								<tr>
									<th class="stick" scope="col">Sell Date</th>
									<th class="stick" scope="col">Item</th>
									<th class="stick" scope="col">Price</th>
								</tr>
							</thead>
							<tbody id="totalSalesModalTableBody">
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="itemBreakdownModal" tabindex="-1" aria-labelledby="itemBreakdownModalLabel" aria-hidden="true">
		<div class="modal-dialog custom-modal">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="itemBreakdownModalLabel"><b><span id="itemName"></b></span> (<span id="itemCount"></span>)</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body custom-modal">
					<div class="scrollable-table show-scrollbar">
						<table class="table content" id="itemBreakdownModalTable">
							<thead>
								<tr>
									<th class="stick" scope="col">Sales Person</th>
									<th class="stick" scope="col">Sell Date</th>
									<th class="stick" scope="col">Price</th>
								</tr>
							</thead>
							<tbody id="itemBreakdownModalTableBody">
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div class="container-fluid">
    <div class="row main-content-row">
      <div class="col-12 col-md-3 left-col">
        <div class="card mb-3 p-4">
          <h5 class="mb-3 text-center">Change the Date Range</h5>
          <%= form_with url: dashboard_path, method: :get, local: true do |form| %>
            <div class="mb-3">
              <%= form.label :start_date, "Start Date", class: "form-label" %>
              <div class="input-group">
                <%= form.text_field :start_date, class: "form-control datepicker", required: true, value: (params[:start_date].presence || Date.current.strftime("%m/%d/%Y")) %>
                <span class="input-group-text datepicker-icon">
                  <i class="bi bi-calendar-date"></i>
                </span>
              </div>
            </div>

            <div class="mb-3">
              <%= form.label :end_date, "End Date", class: "form-label" %>
              <div class="input-group">
                <%= form.text_field :end_date, class: "form-control datepicker", required: true, value: (params[:end_date].presence || Date.current.strftime("%m/%d/%Y")) %>
                <span class="input-group-text datepicker-icon">
                  <i class="bi bi-calendar-date"></i>
                </span>
              </div>
            </div>

            <div class="d-flex justify-content-end">
              <%= form.submit "Submit", class: "btn btn-main", data: { turbo: false }, onclick:"show_spinner()" %>
            </div>
          <% end %>
        </div>
        
        <div class="card p-4" id="filterCard">
          <h5 class="mb-2 text-center">Filters</h5>

          <div class="mb-3 d-flex flex-column align-items-center">
            <select id="sales-person-filter"
                    class="selectpicker btn-secondary filter-select"
                    multiple
                    data-actions-box="true"
                    title="Sales People"
                    data-selected-text-format="count"
                    data-count-selected-text="{0} people selected"
                    data-width="100%">
            </select>
          </div>

          <div class="d-flex flex-column align-items-center">
            <select id="item-filter"
                    class="selectpicker btn-secondary filter-select"
                    multiple
                    data-actions-box="true"
                    title="Items"
                    data-selected-text-format="count"
                    data-count-selected-text="{0} items selected"
                    data-width="100%">
            </select>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-9 right-col">
        <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <a class="nav-link active"
              id="total-sales-tab"
              data-bs-toggle="tab"
              href="#total-sales"
              role="tab"
              aria-controls="total-sales"
              aria-selected="true">
              Total Sales
            </a>
          </li>
          <li class="nav-item" role="presentation">
            <a class="nav-link"
              id="item-breakdown-tab"
              data-bs-toggle="tab"
              href="#item-breakdown"
              role="tab"
              aria-controls="item-breakdown"
              aria-selected="false">
              Item Breakdown
            </a>
          </li>
        </ul>

        <div class="card border-top-0 rounded-bottom">
          <div class="card-body tab-content" id="dashboardTabsContent">
            
            <div class="tab-pane fade show active dashboard-content"
              id="total-sales"
              role="tabpanel"
              aria-labelledby="total-sales-tab">
              
              <div class="mb-1 d-flex justify-content-end">
                <button id="export-total-sales-chart" class="btn btn-main">Export to Excel</button>
              </div>
              
              <div id="total-sales-chart"></div>
            </div>

            <div class="tab-pane fade dashboard-content"
              id="item-breakdown"
              role="tabpanel"
              aria-labelledby="item-breakdown-tab">
              
              <div class="mb-1 d-flex justify-content-end">
                <button id="export-item-breakdown-table" class="btn btn-main">Export to Excel</button>
              </div>
              
              <div class="scrollable-table dashboard-table show-scrollbar">
                <table class="table content" id="itemBreakdownTable">
                  <thead>
                    <tr>
                      <th class="stick" scope="col">Item</th>
                      <th class="stick" scope="col">Sold</th>
                      <th class="stick" scope="col">Amount</th>
                    </tr>
                  </thead>
                  <tbody id="itemBreakdownTableBody">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>

<% if @start_date.present? and @end_date.present? %>
	<script>
		$(document).ready(function() {
			
      function updateFilterSection() {
        const card = document.getElementById("filterCard");
        const selects = document.querySelectorAll('.filter-select');
        const screenHeight = window.innerHeight;

        selects.forEach(select => {
          select.setAttribute('data-dropup-auto', 'false');
          
          // Save desired direction into dataset for later
          if (screenHeight <= 900) {
            select.classList.add('dropup');
          } else {
            select.classList.remove('dropup');
            select.dataset.forceDirection = 'down';
          }
        });
      }

      $(document).on('show.bs.select', '.filter-select', function () {
        const wrapper = $(this).closest('.bootstrap-select');
        const direction = this.dataset.forceDirection;
        if(direction === 'down'){
          wrapper.removeClass('dropup').addClass('dropdown');
        }
      });

      window.addEventListener('resize', updateFilterSection);

      updateFilterSection();

      console.log("Height: " + window.innerHeight);
      
      const salesRecords = <%= raw @sales_records.to_json %>;
			const salesPeople = <%= raw @sales_people.to_json %>;
			const items = <%= raw @items.to_json %>;
      const shifts = <%= raw @shifts.to_json %>;

			console.log("Sales Records:", salesRecords);
			console.log("Sales People:", salesPeople);
			console.log("Items:", items);
      console.log("Shifts:", shifts);

			const salesPersonIdToName = {};
			salesPeople.forEach(sp => {
				const name = `${sp.first_name} ${sp.last_name}`.trim().replace(/\s+/g, ' ');
				salesPersonIdToName[sp.id] = name;
			});

      console.log("SalesPersonIdToName: ", salesPersonIdToName);

      const itemIdToName = {};
			items.forEach(item => {
				itemIdToName[item.id] = item.name;
			});

      console.log("ItemIdToName: ", itemIdToName);

			const totalsByPerson = {};
      salesRecords.forEach(record => {
        const name = (salesPersonIdToName[record.sales_person_id] || '').trim().replace(/\s+/g, ' ');
        const itemId = record.item_id;
        const item = itemIdToName[itemId];
        const price = Number(record.item_price);

        if (!totalsByPerson[name]) totalsByPerson[name] = {};
        if (!totalsByPerson[name][item]) totalsByPerson[name][item] = 0;
        totalsByPerson[name][item] += price;
      });

			const allSortedData = Object.entries(totalsByPerson).sort((a, b) => a[0].localeCompare(b[0]));
			console.log("All Sorted Data: ", allSortedData);

			const groupedSales = {};
			salesRecords.forEach(record => {
				if (!groupedSales[record.item_id]) {
					groupedSales[record.item_id] = {
						name: itemIdToName[record.item_id],
						records: []
					};
				}
				groupedSales[record.item_id].records.push(record);
			});

			const groupedSalesArray = Object.entries(groupedSales).map(([item_id, data]) => ({
        item_id,
        name: data.name,
        records: data.records
      }));
      
			groupedSalesArray.sort((a, b) => {
        const recordDiff = b.records.length - a.records.length;

        if (recordDiff !== 0) {
          return recordDiff; // sort by record count (descending)
        }

        return a.name.localeCompare(b.name); // sort by name (ascending)
      });

      console.log("Grouped Sales Array: ", groupedSalesArray);

      const nameToSalesPersonId = {};
      Object.entries(salesPersonIdToName).forEach(([id, name]) => {
        nameToSalesPersonId[name] = parseInt(id);
      });

      console.log("Name To Sales Person Id: ", nameToSalesPersonId);

      function addPadding(row){
        row.style.paddingTop = "10px";
        row.style.paddingBottom = "10px";
        return row;
      }

			function populateItemSelect(){
				const select = $('#item-filter');
				select.find('option').remove();

				const sortedItems = [...groupedSalesArray].sort((a, b) =>
          a.name.toLowerCase().localeCompare(b.name.toLowerCase())
        );
        
        const optionsHtml = sortedItems.map(item =>
					new Option(item.name, item.item_id, true, true).outerHTML
				).join('');

				select.html(optionsHtml);
				select.selectpicker('destroy');
				select.selectpicker();
			}
			
			function populateSalesPersonSelect() {
				const uniqueNames = [...new Set(allSortedData.map(([name]) => name))].sort();

				let select = $('#sales-person-filter');
				select.find('option').remove();

				const optionsHtml = uniqueNames.map(name => {
          const id = nameToSalesPersonId[name];
          return new Option(name, id, true, true).outerHTML;
        }).join('');

				select.html(optionsHtml);
				select.selectpicker('destroy');
				select.selectpicker();
			}

			function renderItemBreakdownTable(){
				const selectedItemIds = $('#item-filter').val();
        const selectedSalesPeopleIds = $('#sales-person-filter').val();
        
				const tableBody = $('#itemBreakdownTableBody');
  			tableBody.empty();
				if (!selectedItemIds || selectedItemIds.length === 0) return;

				// Filter to only selected items
				let filteredItems = groupedSalesArray.filter(item =>
					selectedItemIds.includes(item.item_id)
				);

				filteredItems = filteredItems.map(item => {
          const filteredRecords = item.records.filter(record =>
            selectedSalesPeopleIds.includes(record.sales_person_id.toString())
          );
          return {
            ...item,
            records: filteredRecords
          };
        }).filter(item => item.records.length > 0);

        filteredItems.forEach(item => {
          
          // sum up the item_price values in the records
          const totalAmount = item.records.reduce((sum, record) => {
            return sum + record.item_price;
          }, 0);
          
          const rowHtml = `
            <tr>
              <td>${item.name}</td>
              <td><a href="#" class="nav-link clickable-item" data-item-id="${item.item_id}">${item.records.length}</a></td>
              <td>$${totalAmount.toLocaleString()}</td>
            </tr>
          `;
          tableBody.append(rowHtml);
        });

        // ðŸŸ¢ Excel export for item breakdown table
        $('#export-item-breakdown-table').off('click').on('click', async () => {
          const startDate = "<%= @start_date.strftime('%m/%d/%Y') %>";
          const endDate = "<%= @end_date.strftime('%m/%d/%Y') %>";
          
          // Extract data directly from the table
          const rows = [];
          $('#itemBreakdownTable tbody tr').each(function() {
            const cells = $(this).find('td');
            rows.push({
              item: $(cells[0]).text().trim(),
              sold: $(cells[1]).text().trim(),
              amount: $(cells[2]).text().trim()
            });
          });

          if (rows.length === 0) {
            return;
          }

          // Create workbook and worksheet
          const wb = new ExcelJS.Workbook();
          const ws = wb.addWorksheet('Item Breakdown');

          // --- Row 1: merged title ---
          ws.mergeCells('A1:C1');
          const titleCell = ws.getCell('A1');
          titleCell.value = `Item Breakdown from ${startDate} to ${endDate}`;
          titleCell.font = { bold: true, size: 13 };
          titleCell.alignment = { horizontal: 'center', vertical: 'middle' };

          // --- Row 2: blank spacer ---
          ws.addRow([]);

          // --- Row 3: headers ---
          const headerRow = ws.addRow(['Item', 'Sold', 'Amount']);
          headerRow.font = { bold: true };
          headerRow.alignment = { horizontal: 'center', vertical: 'middle' };

          // --- Row 4: blank spacer ---
          ws.addRow([]);

          // --- Row 5+: table data ---
          rows.forEach(r => {
            const row = ws.addRow([r.item, r.sold, r.amount]);
            row.alignment = { horizontal: 'center', vertical: 'middle' };
          });

          // --- Column widths ---
          ws.getColumn(1).width = 45; // Item
          ws.getColumn(2).width = 10; // Sold
          ws.getColumn(3).width = 15; // Amount

          // --- Center all cells ---
          ws.eachRow({ includeEmpty: false }, row => {
            row.eachCell(cell => {
              cell.alignment = { horizontal: 'center', vertical: 'middle' };
            });
          });

          // --- Download ---
          const buf = await wb.xlsx.writeBuffer();
          const fileName = `item_breakdown_${startDate.replace(/\//g, '-')}_to_${endDate.replace(/\//g, '-')}.xlsx`;
          saveAs(new Blob([buf], { type: 'application/octet-stream' }), fileName);
        });
			}
			
			function renderTotalSalesChart() {
				const selectedPeople = $('#sales-person-filter').val();
        const selectedItems = $('#item-filter').val();

        const selectedItemNames = selectedItems
        .map(id => itemIdToName[id.toString()])
        .filter(name => !!name);
        
        const selectedPeopleNames = selectedPeople
        .map(id => salesPersonIdToName[id.toString()]);

				const filteredData = selectedPeopleNames.map(name => {
          const id = nameToSalesPersonId[name];

          // All sales for this person + item filter
          const personSales = salesRecords.filter(record =>
            record.sales_person_id === id &&
            selectedItems.includes(record.item_id.toString())
          );

          const salesDates = [...new Set(personSales.map(s => s.sell_date))];
          const totalSales = personSales.reduce((sum, sale) => sum + sale.item_price, 0);
          const numberOfSales = personSales.length;

          // Only include shifts that match sales dates
          const personShifts = shifts.filter(shift =>
            shift.sales_person_id === id &&
            salesDates.includes(shift.shift_date)
          );

          const totalSalesHours = personShifts.reduce((sum, shift) => {
            return sum + (parseFloat(shift.sales_floor_hours) || 0);
          }, 0);

          const totalProjectHours = personShifts.reduce((sum, shift) => {
            return sum + (parseFloat(shift.project_hours) || 0);
          }, 0);

          const avgPerHour = totalSalesHours > 0 ? totalSales / totalSalesHours : 0;

          const itemTotals = totalsByPerson[name] || {};
          const total = Object.entries(itemTotals)
            .filter(([itemName]) => selectedItemNames.includes(itemName))
            .reduce((sum, [, amount]) => sum + amount, 0);

          return {
            name,
            id,
            totalSales,
            totalProjectHours,
            numberOfSales,
            totalSalesHours,
            avgPerHour
          };
        }).filter(p => p.totalSales > 0);

        // Sort by total sales (highest first)
        filteredData.sort((a, b) => b.totalSales - a.totalSales);

				const filteredSales = salesRecords.filter(record =>
          selectedPeople.includes(record.sales_person_id.toString()) &&
          selectedItems.includes(record.item_id.toString())
        );

        const totalSales = filteredSales.reduce((accumulator, sale) =>{
          return accumulator + sale.item_price;
        }, 0);

				const categories = filteredData.map(p => p.name);
				const data = filteredData.map(p => ({
          y: p.totalSales,
          custom: {
            project_hours: p.totalProjectHours,
            number_of_sales: p.numberOfSales,
            sales_hours: p.totalSalesHours,
            avg: p.avgPerHour
          }
        }));

				Highcharts.chart('total-sales-chart', {
					chart: {
						type: 'column',
            marginTop: 130,
            scrollablePlotArea: {
              minWidth: categories.length * 100,
              scrollPositionX: 1
            }
					},
					title: {
            useHTML: true,
						text: 
            `<div style="text-align: center;">
              <div style="font-size: 22px;">
                <% if @start_date == @end_date %>
                  Total Sales for <%= @start_date.strftime("%m/%d/%Y") %>
                <% else %>
                  Total Sales from <%= @start_date.strftime("%m/%d/%Y") %> to <%= @end_date.strftime("%m/%d/%Y") %>
                <% end %>
              </div>
            </div>
            `
					},
					subtitle: {
						useHTML: true,
            text: `
              <div style="text-align: center;">
                <div style="font-size: 18px; font-weight: bold; color: #333;">
                  $${totalSales.toLocaleString()}
                </div>
                <div style="font-size: 14px; font-weight: bold; color: #777;">
                  ${filteredSales.length.toLocaleString()} sale${filteredSales.length === 1 ? '' : 's'}
                </div>
              </div>
            `
					},
					xAxis: {
						categories: categories,
						title: { text: 'Sales People' },
					},
					yAxis: {
						min: 0,
						title: { text: 'Total Sales ($)' }
					},
					tooltip: {
						enabled: false
					},
					plotOptions: {
						column: {
							cursor: 'pointer',
							point: {
								events: {
									click: function() {
										showTotalSalesForClickedPerson(this.category);
									}
								}
							},
							dataLabels: {
                enabled: true,
                inside: false,
                crop: false,
                overflow: 'none',
                useHTML: true,
                formatter: function() {
                  const sales = '$' + Highcharts.numberFormat(this.y, 0, '.', ',');
                  const number_of_sales = this.point.custom?.number_of_sales || 0;
                  const project_hours = this.point.custom?.project_hours || 0;
                  const sales_hours = this.point.custom?.sales_hours || 0;
                  const avg = this.point.custom?.avg || 0;
                  
                  let labelString = `<div style="text-align: center;">
                      <div>${sales}</div>
                      <div style="font-size: 12px; color: #777;">
                        ${number_of_sales.toLocaleString()} sale${number_of_sales === 1 ? '' : 's'}
                      </div>
                    </div>`;
                  
                  if(avg > 0){
                    labelString = `<div style="text-align: center;">
                      <div>${sales}</div>
                      <div style="font-size: 12px; color: #777;">
                        ${number_of_sales.toLocaleString()} sale${number_of_sales === 1 ? '' : 's'}
                      </div>
                      <div style="font-size: 12px; color: #007bff;">
                        $${avg.toFixed(2)}/hr
                      </div>
                    </div>`;
                  }

                  return labelString;
                },
                style: {
                  color: '#333',
                  fontSize: '14px'
                }
              }
						}
					},
					series: [{
						name: 'Total Sales',
						data: data,
						color: '#193856'
					}],
					exporting: {
						enabled: true
					},
          credits: {
            enabled: false
          }
				});

        $('#export-total-sales-chart').off('click').on('click', async () => {
          const startDate = "<%= @start_date.strftime('%m/%d/%Y') %>";
          const endDate = "<%= @end_date.strftime('%m/%d/%Y') %>";
          
          // Prepare JSON data for Excel
          const excelData = filteredData.map(p => ({
            salesPerson: p.name,
            totalProjectHours: p.totalProjectHours,
            totalSalesHours: p.totalSalesHours,
            totalSales: p.totalSales,
            avgPerHour: p.avgPerHour,
            numberOfSales: p.numberOfSales
          }));

          if (excelData.length === 0) return;

          // Create workbook & worksheet
          const wb = new ExcelJS.Workbook();
          const ws = wb.addWorksheet('Total Sales');

          // Row 1: Merged title
          ws.mergeCells('A1:F1');
          const titleCell = ws.getCell('A1');
          
          titleCell.value = `Total Sales from ${startDate} to ${endDate}`;
          let fileName = `total_sales_${startDate.replace(/\//g, '-')}_to_${endDate.replace(/\//g, '-')}.xlsx`;
          
          if(startDate === endDate){
            titleCell.value = `Total Sales for ${startDate}`;
            fileName = `total_sales_for_${startDate.replace(/\//g, '-')}.xlsx`;
          } 
            
          titleCell.alignment = { horizontal: 'center', vertical: 'middle' };
          titleCell.font = { bold: true, size: 12 };

          // Row 2: Total Sales summary
          ws.mergeCells('A2:F2');
          const totalSalesCell = ws.getCell('A2');
          totalSalesCell.value = `Total Sales: $${totalSales.toLocaleString()}`;
          totalSalesCell.alignment = { horizontal: 'center', vertical: 'middle' };
          totalSalesCell.font = { bold: true };

          // Row 3: Number of sales
          ws.mergeCells('A3:F3');
          const totalCountCell = ws.getCell('A3');
          totalCountCell.value = `Total Number of Sales: ${filteredSales.length.toLocaleString()}`;
          totalCountCell.alignment = { horizontal: 'center', vertical: 'middle' };
          totalCountCell.font = { bold: true };

          // Row 4: Blank

          // Row 5: Headers
          const headerRow = ws.getRow(5);
          headerRow.values = ['Sales Person','Number of Sales','Total Sales ($)','Sales Floor Hours','Avg per Hour ($)','Project Hours'];
          headerRow.font = { bold: true };
          headerRow.alignment = { horizontal: 'center', vertical: 'middle' };

          // Row 6: Blank
          
          // Starting at row 7, insert data
          let rowIndex = 7;
          excelData.forEach(r => {
            const row = ws.getRow(rowIndex);
            row.getCell(1).value = r.salesPerson;
            row.getCell(2).value = r.numberOfSales;
            row.getCell(3).value = r.totalSales;
            row.getCell(4).value = r.totalSalesHours;
            row.getCell(5).value = r.avgPerHour;
            row.getCell(6).value = r.totalProjectHours;

            // Align all cells center
            [1,2,3,4,5,6].forEach(c => {
              row.getCell(c).alignment = { horizontal: 'center', vertical: 'middle' };
            });

            // Format currency for column 3 & 5
            row.getCell(3).numFmt = '"$"#,##0.00;[Red]-"$"#,##0.00';
            row.getCell(5).numFmt = '"$"#,##0.00;[Red]-"$"#,##0.00';

            row.commit();
            rowIndex++;
          });

          // Set column widths
          ws.getColumn(1).width = 25;
          ws.getColumn(2).width = 25;
          ws.getColumn(3).width = 25;
          ws.getColumn(4).width = 25;
          ws.getColumn(5).width = 25;
          ws.getColumn(6).width = 25;

          // Format Total Sales ($) as currency
          for (let i = 0; i < excelData.length; i++) {
            const cellRef = `B${i + 5}`; // column B, starting row 5
            const cell = ws[cellRef];
            if (cell) {
              cell.z = '$#,##0.00';
            }
          }

          // Generate file and trigger download
          const buf = await wb.xlsx.writeBuffer();
          saveAs(new Blob([buf], { type: 'application/octet-stream' }), fileName);
        });
    	}

			function showTotalSalesForClickedPerson(clickedName) {
				const salesPersonId = Object.keys(salesPersonIdToName).find(
					id => salesPersonIdToName[id] === clickedName
				);

				const selectedItemIds = $('#item-filter').val() || [];

        const filteredRecords = salesRecords
        .filter(record =>
          record.sales_person_id == salesPersonId &&
          selectedItemIds.includes(record.item_id.toString())
        );

				console.log(`Sales records for ${clickedName}:`, filteredRecords);
				document.getElementById('salesPersonName').textContent = clickedName;
				document.getElementById('salesPersonRecordCount').textContent = filteredRecords.length;

				const tbody = document.querySelector('#totalSalesModalTableBody');
				tbody.innerHTML = '';

				let overallTotal = 0;
        let overallProjectHours = 0;
        let overallSalesHours = 0;

        // First sort the records
        const sortedRecords = filteredRecords.sort((a, b) => {
          // Compare by date
          const dateA = new Date(a.sell_date);
          const dateB = new Date(b.sell_date);

          if (dateA < dateB) return -1;
          if (dateA > dateB) return 1;

          // If dates are the same, compare by id ascending
          return a.id - b.id;
        });

				// Group records by date
				const groupedByDate = {};
				sortedRecords.forEach(record => {
					const date = luxon.DateTime.fromISO(record.sell_date).toFormat('MM/dd/yyyy');
					if (!groupedByDate[date]) groupedByDate[date] = [];
					groupedByDate[date].push(record);
				});

				const uniqueDates = Object.keys(groupedByDate).sort();

				// --- Calculate total hours worked across matching shift dates ---
        const shiftDates = uniqueDates.map(d =>
          luxon.DateTime.fromFormat(d, 'MM/dd/yyyy').toISODate()
        );

        const personShifts = shifts.filter(
          s =>
          s.sales_person_id == salesPersonId &&
          shiftDates.includes(luxon.DateTime.fromISO(s.shift_date).toISODate())
        );

        const totalSalesHours = personShifts.reduce(
          (sum, s) => sum + (parseFloat(s.sales_floor_hours) || 0),
          0
        );

        const totalProjectHours = personShifts.reduce(
          (sum, s) => sum + (parseFloat(s.project_hours) || 0),
          0
        );
        
        uniqueDates.forEach(date => {
					let dailyTotal = 0;
					groupedByDate[date].forEach(record => {
						
						const itemRecord = items.find(
							item => item.id === record.item_id
						);

						const row = document.createElement('tr');
						row.innerHTML = `
							<td>${date}</td>
							<td>${itemRecord.name}</td>
							<td>$${record.item_price.toLocaleString()}</td>
						`;
						tbody.appendChild(row);
						dailyTotal += parseFloat(record.item_price);
						overallTotal += parseFloat(record.item_price);
					});

          // --- Find matching shift for that date ---
          const isoDate = luxon.DateTime.fromFormat(date, 'MM/dd/yyyy').toISODate();
          const dayShift = shifts.find(
            s => s.sales_person_id == salesPersonId &&
            luxon.DateTime.fromISO(s.shift_date).toISODate() === isoDate
          );
          const daySalesHours = dayShift ? parseFloat(dayShift.sales_floor_hours || 0) : 0;
          const dayProjectHours = dayShift ? parseFloat(dayShift.project_hours || 0) : 0;
          const dayAvg = daySalesHours > 0 ? dailyTotal / daySalesHours : 0;
          overallProjectHours += dayProjectHours;
          overallSalesHours += daySalesHours;

					// Only show day total if thereâ€™s more than one day of data
					if (uniqueDates.length > 1) {
            //add a row for spacing
            const spaceRow = document.createElement('tr');
            spaceRow.innerHTML = `
            <td colspan="3"></td>
            `;
            tbody.appendChild(spaceRow);
            
            if(dayProjectHours > 0){
              const projectHoursRow = document.createElement('tr');
              projectHoursRow.classList.add('daily-total-row');
              projectHoursRow.innerHTML = `
                <td colspan="2" style="text-align: right; font-weight: bold;">
                  Project Hours
                </td>
                <td><strong>${dayProjectHours}</strong></td>
              `;
              tbody.appendChild(projectHoursRow);
            }
            
            if(daySalesHours > 0){
              const hoursOnFloorRow = document.createElement('tr');
              hoursOnFloorRow.classList.add('daily-total-row');
              hoursOnFloorRow.innerHTML = `
                <td colspan="2" style="text-align: right; font-weight: bold;">
                  Sales Floor Hours
                </td>
                <td><strong>${daySalesHours}</strong></td>
              `;
              tbody.appendChild(hoursOnFloorRow);
            }
            
            const dailyTotalRow = document.createElement('tr');
						dailyTotalRow.classList.add('daily-total-row');
						dailyTotalRow.innerHTML = `
              <td colspan="2" style="text-align: right; font-weight: bold;">
                Day Total
              </td>
              <td><strong>$${dailyTotal.toLocaleString()}</strong></td>
            `;
            addPadding(dailyTotalRow);
						tbody.appendChild(dailyTotalRow);
					}

          //add a row for spacing after
          const spaceRow = document.createElement('tr');
          spaceRow.innerHTML = `
          <td colspan="3"></td>
          `;
          tbody.appendChild(spaceRow);
				});

        if(overallProjectHours > 0){
          const totalProjectHoursRow = document.createElement('tr');
          totalProjectHoursRow.classList.add('daily-total-row');
          totalProjectHoursRow.innerHTML = `
            <td colspan="2" style="text-align: right; font-weight: bold;">
              Total Project Hours
            </td>
            <td><strong>${overallProjectHours}</strong></td>
          `;
          tbody.appendChild(totalProjectHoursRow);
        }

				if(overallSalesHours > 0){
          const totalSalesFloorHoursRow = document.createElement('tr');
          totalSalesFloorHoursRow.classList.add('daily-total-row');
          totalSalesFloorHoursRow.innerHTML = `
            <td colspan="2" style="text-align: right; font-weight: bold;">
              Total Sales Floor Hours
            </td>
            <td><strong>${overallSalesHours}</strong></td>
          `;
          tbody.appendChild(totalSalesFloorHoursRow);
        }
        
        // Overall total
				const totalRow = document.createElement('tr');
				totalRow.innerHTML = `
					<td colspan="2" style="text-align: right;"><strong>Grand Total</strong></td>
					<td><strong>$${overallTotal.toLocaleString()}</strong></td>
				`;
        addPadding(totalRow);
				tbody.appendChild(totalRow);

        if(overallSalesHours > 0){
          const totalAvg = (overallTotal / overallSalesHours).toFixed(2);

          // Overall average
          const avgRow = document.createElement('tr');
          avgRow.innerHTML = `
            <td colspan="2" style="text-align: right;"><strong>Average Per Hour</strong></td>
            <td><strong>$${totalAvg.toLocaleString()}/hr</strong></td>
          `;
          addPadding(avgRow);
          tbody.appendChild(avgRow);
        }
        
				const modal = new bootstrap.Modal(document.getElementById('totalSalesModal'));
				modal.show();
			}

			populateSalesPersonSelect();
      populateItemSelect();
			renderTotalSalesChart();
			renderItemBreakdownTable();

			$('#item-filter').on('changed.bs.select', function () {
				renderTotalSalesChart();
        renderItemBreakdownTable();
			});

			$('#sales-person-filter').on('changed.bs.select', function () {
  			renderTotalSalesChart();
        renderItemBreakdownTable();
			});

			$(document).on('click', '.clickable-item', function (e) {
        e.preventDefault();

        const itemId = $(this).data('item-id');
        const itemData = groupedSales[itemId];

        if (!itemData) return;

        const itemName = itemData.name;
        const records = itemData.records;

        // Sort by date
        records.sort((a, b) => 
          luxon.DateTime.fromISO(a.sell_date) - luxon.DateTime.fromISO(b.sell_date)
        );

        // Set modal title values
        $('#itemName').text(itemName);
        $('#itemCount').text(records.length);

        const tbody = document.querySelector('#itemBreakdownModalTableBody');
        tbody.innerHTML = '';

        let overallTotal = 0;

        records.forEach(record => {
          const salesPersonName = salesPersonIdToName[record.sales_person_id];
          const sellDate = luxon.DateTime.fromISO(record.sell_date).toFormat('MM/dd/yyyy');
          const itemPrice = parseFloat(record.item_price);

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${salesPersonName}</td>
            <td>${sellDate}</td>
            <td>$${itemPrice.toLocaleString()}</td>
          `;
          tbody.appendChild(row);

          overallTotal += itemPrice;
        });

        // Add spacing row
        const spaceRow = document.createElement('tr');
        spaceRow.innerHTML = `<td colspan="3"></td>`;
        tbody.appendChild(spaceRow);

        // Add total row
        const totalRow = document.createElement('tr');
        totalRow.innerHTML = `
          <td colspan="2" style="text-align: right;"><strong>Total</strong></td>
          <td><strong>$${overallTotal.toLocaleString()}</strong></td>
        `;
        addPadding(totalRow);
        tbody.appendChild(totalRow);

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('itemBreakdownModal'));
        modal.show();
      });

		});
	</script>
<% end %>