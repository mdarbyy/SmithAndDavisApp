<% if @start_date.blank? || @end_date.blank? %>
  <div class="d-flex justify-content-center align-items-center" style="min-height: 60vh;">
    <div class="card p-4 shadow" style="max-width: 500px; width: 100%;">
      <h4 class="mb-3 text-center">Select a Date Range</h4>
      <%= form_with url: dashboard_path, method: :get, local: true do |form| %>
        <div class="mb-3">
          <%= form.label :start_date, "Start Date", class: "form-label" %>
          <%= form.date_field :start_date, class: "form-control", required: true, value: params[:start_date].presence || Date.current.strftime("%Y-%m-%d") %>
        </div>
        <div class="mb-3">
          <%= form.label :end_date, "End Date", class: "form-label" %>
          <%= form.date_field :end_date, class: "form-control", required: true, value: params[:end_date].presence || Date.current.strftime("%Y-%m-%d") %>
        </div>
        <div class="d-flex justify-content-end">
          <%= form.submit "View Dashboard", class: "btn btn-main", onclick:"show_spinner()" %>
        </div>
      <% end %>
    </div>
  </div>
<% else %>
    
	<div class="modal fade" id="totalSalesModal" tabindex="-1" aria-labelledby="totalSalesModalLabel" aria-hidden="true">
		<div class="modal-dialog custom-modal">
			<div class="modal-content" style="width: 750px;">
				<div class="modal-header">
					<h5 class="modal-title" id="totalSalesModalLabel">Sales Records for <b><span id="salesPersonName"></span></b> (<span id="salesPersonRecordCount"></span>)</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body custom-modal">
					<div class="scrollable-table">
						<table class="table content" id="content-table">
							<thead>
								<tr>
									<th class="stick" scope="col">Sell Date</th>
									<th class="stick" scope="col">Item</th>
									<th class="stick" scope="col">Price</th>
								</tr>
							</thead>
							<tbody id="totalSalesTableBody">
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="salesBreakdownModal" tabindex="-1" aria-labelledby="salesBreakdownModalLabel" aria-hidden="true">
		<div class="modal-dialog custom-modal">
			<div class="modal-content" style="width: 750px;">
				<div class="modal-header">
					<h5 class="modal-title" id="salesBreakdownModalLabel"><b><span id="itemName"></b></span> (<span id="itemCount"></span>)</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body custom-modal">
					<div class="scrollable-table">
						<table class="table content" id="content-table">
							<thead>
								<tr>
									<th class="stick" scope="col">Sales Person</th>
									<th class="stick" scope="col">Sell Date</th>
									<th class="stick" scope="col">Price</th>
								</tr>
							</thead>
							<tbody id="salesBreakdownModalTableBody">
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div class="container-fluid">
		<div class="row">
			<div class="col-12 col-md-3">
				<div class="card p-4 shadow-sm">
					<h5 class="mb-3 text-center">Change the Date Range</h5>
					<%= form_with url: dashboard_path, method: :get, local: true do |form| %>
						<div class="mb-3">
							<%= form.label :start_date, "Start Date", class: "form-label" %>
							<%= form.date_field :start_date, class: "form-control", value: params[:start_date], required: true %>
						</div>
						<div class="mb-3">
							<%= form.label :end_date, "End Date", class: "form-label" %>
							<%= form.date_field :end_date, class: "form-control", value: params[:end_date], required: true %>
						</div>
						<div class="d-flex justify-content-end">
							<%= form.submit "Submit", class: "btn btn-main", onclick:"show_spinner()" %>
						</div>
					<% end %>
				</div>
			</div>

			<div class="col-12 col-md-9">
				<ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
					<li class="nav-item" role="presentation">
						<a class="nav-link active" id="total-sales-tab" data-bs-toggle="tab" href="#total-sales" role="tab" aria-controls="total-sales" aria-selected="true">
							Total Sales
						</a>
					</li>
					<li class="nav-item" role="presentation">
						<a class="nav-link" id="sales-breakdown-tab" data-bs-toggle="tab" href="#sales-breakdown" role="tab" aria-controls="sales-breakdown" aria-selected="true">
							Sales Breakdown
						</a>
					</li>
				</ul>

				<div class="card border-top-0 rounded-bottom">
					<div class="card-body tab-content" id="dashboardTabsContent">
						<div class="tab-pane fade show active" id="total-sales" role="tabpanel" aria-labelledby="total-sales-tab">
							
							<div class="row mb-3">
								<div class="col d-flex flex-column align-items-center">
									<select id="sales-person-filter" class="selectpicker btn-secondary" multiple data-actions-box="true" title="Sales People" data-selected-text-format="count" data-count-selected-text="{0} people selected" data-width="100%"></select>
								</div>
							</div>

							<div class="row">
								<div class="col">
									<div id="sales-bar-chart" class="dashboard-content"></div>
								</div>
							</div>
							
						</div>
						<div class="tab-pane fade show" id="sales-breakdown" role="tabpanel" aria-labelledby="sales-breakdown-tab">
							
							<div class="row mb-3">
								<div class="col d-flex flex-column align-items-center">
									<select id="item-filter" class="selectpicker btn-secondary" multiple data-actions-box="true" title="Items" data-selected-text-format="count" data-count-selected-text="{0} items selected" data-width="100%"></select>
								</div>
							</div>

							<div class="row">
								<div class="col">
									<div class="scrollable-table dashboard-content">
										<table class="table content">
											<thead>
												<tr>
													<th class="stick" scope="col">Item</th>
													<th class="stick" scope="col">Amount Sold</th>
												</tr>
											</thead>
											<tbody id="salesBreakdownTableBody">
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
<% end %>

<% if @start_date.present? and @end_date.present? %>
	<script>
		$(document).ready(function() {
			const salesRecords = <%= raw @sales_records.to_json %>;
			const salesPeople = <%= raw @sales_people.to_json %>;
			const Items = <%= raw @items.to_json %>;

			console.log("Sales Records:", salesRecords);
			console.log("Sales People:", salesPeople);
			console.log("Items:", Items);

			const salesPersonIdToName = {};
			salesPeople.forEach(sp => {
				const name = `${sp.first_name} ${sp.last_name}`.trim().replace(/\s+/g, ' ');
				salesPersonIdToName[sp.id] = name;
			});

			const totalsByPerson = {};
			salesRecords.forEach(record => {
				const name = (salesPersonIdToName[record.sales_person_id]).trim().replace(/\s+/g, ' ');
				const price = Number(record.item_price);

				if (!totalsByPerson[name]) totalsByPerson[name] = 0;
				totalsByPerson[name] += price;
			});

			const allSortedData = Object.entries(totalsByPerson).sort((a, b) => a[0].localeCompare(b[0]));
			console.log(allSortedData);

			const itemIdToName = {};
			Items.forEach(item => {
				itemIdToName[item.id] = item.name;
			});

			const groupedSales = {};
			salesRecords.forEach(record => {
				if (!groupedSales[record.item_id]) {
					groupedSales[record.item_id] = {
						name: itemIdToName[record.item_id],
						records: []
					};
				}
				groupedSales[record.item_id].records.push(record);
			});

			const groupedSalesArray = Object.entries(groupedSales).map(([item_id, data]) => ({
        item_id,
        name: data.name,
        records: data.records
      }));
			groupedSalesArray.sort((a, b) => a.name.localeCompare(b.name));

			console.log("Grouped Sales: ", groupedSalesArray);
			
			function populateSalesBreakdownItemSelect(){
				const select = $('#item-filter');
				select.find('option').remove();

				const optionsHtml = groupedSalesArray.map(item =>
					new Option(item.name, item.item_id, true, true).outerHTML
				).join('');

				select.html(optionsHtml);
				select.selectpicker('destroy');
				select.selectpicker();
			}
			
			function populateTotalSalesSalesPersonSelect() {
				const uniqueNames = [...new Set(allSortedData.map(([name]) => name))].sort();

				let select = $('#sales-person-filter');
				select.find('option').remove();

				const optionsHtml = uniqueNames.map(name => 
					new Option(name, name, true, true).outerHTML
				).join('');

				select.html(optionsHtml);
				select.selectpicker('destroy');
				select.selectpicker();
			}

			function renderSalesBreakdownTable(){
				const selectedItemIds = $('#item-filter').val();
				const tableBody = $('#salesBreakdownTableBody');
  			tableBody.empty();
				if (!selectedItemIds || selectedItemIds.length === 0) return;

				// Filter to only selected items
				const filteredItems = groupedSalesArray.filter(item =>
					selectedItemIds.includes(item.item_id)
				);

				filteredItems.forEach(item => {
					const rowHtml = `
						<tr>
							<td>${item.name}</td>
							<td><a href="#" class="nav-link" data-item-id="${item.item_id}">${item.records.length}</a></td>
						</tr>
					`;
					tableBody.append(rowHtml);
				});

			}
			
			function renderTotalSalesChart() {
				const selectedNames = $('#sales-person-filter').val();	

				const filteredData = allSortedData.filter(([name]) =>
          selectedNames.includes(name)
        );

				const nameToSalesPersonId = {};
				Object.entries(salesPersonIdToName).forEach(([id, name]) => {
					nameToSalesPersonId[name] = parseInt(id);
				});

				const selectedIds = selectedNames.map(name => nameToSalesPersonId[name]);
				// Count how many sales_records match those sales_person_ids
				const matchingSalesCount = salesRecords.filter(record => 
					selectedIds.includes(record.sales_person_id)
				).length;

				const categories = filteredData.map(([name]) => name);
				const data = filteredData.map(([name, total]) => total);

				Highcharts.chart('sales-bar-chart', {
					chart: {
						type: 'column'
					},
					title: {
						<% if @start_date == @end_date %>
							text: 'Total Sales for <%= Date.parse(@start_date).strftime("%m/%d/%Y") %>'
						<% else %>
							text: 'Total Sales from <%= Date.parse(@start_date).strftime("%m/%d/%Y") %> to <%= Date.parse(@end_date).strftime("%m/%d/%Y") %>'
						<% end %>
					},
					subtitle: {
						text: 'Sales: ' + matchingSalesCount,
						style: {
							fontSize: '18px', 
							color: '#333'
						}
					},
					xAxis: {
						categories: categories,
						title: { text: 'Sales Person' }
					},
					yAxis: {
						min: 0,
						title: { text: 'Total Sales ($)' }
					},
					tooltip: {
						enabled: false
					},
					plotOptions: {
						column: {
							cursor: 'pointer',
							point: {
								events: {
									click: function() {
										showTotalSalesForClickedPerson(this.category);
									}
								}
							},
							dataLabels: {
								enabled: true,
								formatter: function() {
									return '$' + Highcharts.numberFormat(this.y, 0, '.', ',');
								},
								style: {
									color: '#333',
									fontSize: '16px'
								}
							}
						}
					},
					series: [{
						name: 'Total Sales',
						data: data,
						color: '#193856'
					}],
					exporting: {
						enabled: true
					}
				});
    	}

			function showTotalSalesForClickedPerson(clickedName) {
				const salesPersonId = Object.keys(salesPersonIdToName).find(
					id => salesPersonIdToName[id] === clickedName
				);

				const filteredRecords = salesRecords
					.filter(record => record.sales_person_id == salesPersonId)
					.sort((a, b) => new Date(a.sell_date) - new Date(b.sell_date));

				console.log(`Sales records for ${clickedName}:`, filteredRecords);
				document.getElementById('salesPersonName').textContent = clickedName;
				document.getElementById('salesPersonRecordCount').textContent = filteredRecords.length;

				const tbody = document.querySelector('#totalSalesTableBody');
				tbody.innerHTML = '';

				let overallTotal = 0;

				// Group records by date
				const groupedByDate = {};
				filteredRecords.forEach(record => {
					const date = luxon.DateTime.fromISO(record.sell_date).toFormat('MM/dd/yyyy');
					if (!groupedByDate[date]) groupedByDate[date] = [];
					groupedByDate[date].push(record);
				});

				const uniqueDates = Object.keys(groupedByDate);

				uniqueDates.forEach(date => {
					let dailyTotal = 0;
					groupedByDate[date].forEach(record => {
						
						const itemRecord = Items.find(
							item => item.id === record.item_id
						);

						const row = document.createElement('tr');
						row.innerHTML = `
							<td>${date}</td>
							<td>${itemRecord.name}</td>
							<td>$${record.item_price}</td>
						`;
						tbody.appendChild(row);
						dailyTotal += parseFloat(record.item_price);
						overallTotal += parseFloat(record.item_price);
					});

					// Only show daily total if thereâ€™s more than one day of data
					if (uniqueDates.length > 1) {
						const dailyTotalRow = document.createElement('tr');
						dailyTotalRow.classList.add('daily-total-row');
						dailyTotalRow.innerHTML = `
							<td colspan="2" style="text-align: right; font-weight: bold;">Day Total</td>
							<td><strong>$${dailyTotal.toLocaleString()}</strong></td>
						`;
						tbody.appendChild(dailyTotalRow);
					}

          //add a row for spacing
          const spaceRow = document.createElement('tr');
          spaceRow.innerHTML = `
					<td colspan="3"></td>
				  `;
          tbody.appendChild(spaceRow);
				});

				// Overall total
				const totalRow = document.createElement('tr');
				totalRow.innerHTML = `
					<td colspan="2" style="text-align: right;"><strong>Grand Total</strong></td>
					<td><strong>$${overallTotal.toLocaleString()}</strong></td>
				`;
				tbody.appendChild(totalRow);

				const modal = new bootstrap.Modal(document.getElementById('totalSalesModal'));
				modal.show();
			}

			populateTotalSalesSalesPersonSelect();
			renderTotalSalesChart();
			populateSalesBreakdownItemSelect();
			renderSalesBreakdownTable();

			$('#item-filter').on('changed.bs.select', function () {
				renderSalesBreakdownTable();
			});

			$('#sales-person-filter').on('changed.bs.select', function () {
  			renderTotalSalesChart();
			});

			$(document).on('click', '.nav-link', function (e) {
				e.preventDefault();

				const itemId = $(this).data('item-id');
				const itemData = groupedSales[itemId];

				if (!itemData) return;

				const itemName = itemData.name;
				const records = itemData.records;

				// Set modal title values
				$('#itemName').text(itemName);
				$('#itemCount').text(records.length);

				// Build table rows
				const rowsHtml = records.map(record => {
					const salesPersonName = salesPersonIdToName[record.sales_person_id];
					const sellDate = luxon.DateTime.fromISO(record.sell_date).toFormat('MM/dd/yyyy');
					const itemPrice = `$${parseFloat(record.item_price)}`;

					return `
						<tr>
							<td>${salesPersonName}</td>
							<td>${sellDate}</td>
							<td>${itemPrice}</td>
						</tr>
					`;
				}).join('');

				// Inject the rows into the modal table
				$('#salesBreakdownModalTableBody').html(rowsHtml);

				// Show the modal (jQuery-based Bootstrap call)
				$('#salesBreakdownModal').modal('show');
			});

		});
	</script>
<% end %>